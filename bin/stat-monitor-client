require 'json'
require 'socket'

require 'stat-monitor'

connectionPort = 9445

$processing = false
$running = true

puts JSON.generate(Stats::LocalStats.get)
exit

#Daemonize.
exit if fork
Process.setsid
exit if fork
Dir.chdir "/"
STDIN.reopen "/dev/null"
STDOUT.reopen "/dev/null"
STDERR.reopen "/dev/null"

Signal.trap("STOP") do
  exit unless $processing
  $running = false
end

#Monitor incoming packets.
socket = TCPServer.new(connectionPort)
while $running do
  Thread.start(socket.accept) do |client|
    $processing = true
    client.write(JSON.generate(Stats::LocalStats.get))
    client.close
    $processing = false
  end
end
