#!/usr/bin/ruby

#This file is an executable that serves as the client program for the stat monitor.
#It runs as a daemon on each monitored machine.
#
#Its configuration file is stored in /etc/stat-monitor/client.rc.

require 'fileutils'

require 'statmonitor/client'

config = nil

begin
  config = StatMonitor::Config.new('/etc/stat-monitor/client.rc')

  client = StatMonitor::Client.new(config)

  client.daemonize() if config.root_dir == '/'

  client.run()
rescue => e
  #Try to write to the log.
  begin
    File.open(config.log_file, "w") do |log|
      log.puts e.message
      log.puts e.backtrace.inspect
    end
  rescue => e2
    #If we can't write to the log, at least try to write to standard output.
    puts e.message
    puts e.backtrace.inspect
    puts '-------------------'
    puts "Unable to write to log file:"
    puts e2.message
    puts e2.backtrace.inspect
  end
end
